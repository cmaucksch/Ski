/* ---------- CSV-Import (Zusammenfassungs-Zeilen entfernen) ---------- */
function importCSV(){
  if(!confirm('⚠️ Vorhandene Daten werden durch Import ersetzt/überschrieben. Fortfahren?')) return;
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv';
  input.onchange = async e => {
    const file = e.target.files[0];
    if(!file) return;
    const text = await file.text();
    if(!text.includes('Ski-Paar;ISO;Datum;Uhrzeit;Aktion')){ alert('Keine gültige Ski-Tracker-CSV'); return; }

    const lines = text.split(/\r?\n/)
      .map(l => l.trim())
      .filter(l =>
        l &&
        !l.startsWith('Zusammenfassung') &&
        !/^[^;]+;\d+;\d+$/.test(l)   // ← entfernt SL1;10;5 usw.
      );

    // alle Zähler zurücksetzen
    skis.forEach(s => {
      s.count = 0;
      s.lastService = 0;
      s.history = [];
    });

    let impCount = 0, skipCount = 0;

    for(const ln of lines){
      const p = ln.split(';');
      if(p.length < 7 || p[0] === 'Ski-Paar') continue;
      const name   = p[0].trim();
      const iso    = p[1].trim();
      const act    = p[4].trim();
      const wachs  = p[5] ? p[5].split(',').map(s => s.trim()).filter(Boolean) : [];
      const geb    = p[6] || '';
      const ts     = new Date(iso).valueOf();
      if(isNaN(ts)) continue;

      let ski = skis.find(s => s.name === name);
      if(!ski){
        ski = {name, count: 0, lastService: 0, history: []};
        skis.push(ski);
      }

      ski.history.push({
        type:  act === 'Service' ? 'service' : 'skiday',
        ts:    ts,
        wachs: act === 'Service' ? wachs : undefined,
        gebiet:act === 'skiday'  ? geb   : undefined
      });
      impCount++;
    }

    // --- ZÄHLER AM ENDE KORREKT AUS HISTORY BERECHNEN ---
    skis.forEach(ski => {
      ski.count = ski.history.filter(h => h.type === 'skiday').length;
      const lastServIndex = ski.history.map(h => h.type).lastIndexOf('service');
      ski.lastService = lastServIndex === -1
        ? 0
        : ski.history.slice(0, lastServIndex).filter(h => h.type === 'skiday').length;
    });

    save(); render();
    alert(`Importiert: ${impCount}\nÜbersprungen (Duplikate): ${skipCount}`);
  };
  input.click();
}
