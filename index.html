/* ---------- CSV-Import (repariert) ---------- */
function importCSV(){
  const input=document.createElement('input');
  input.type='file';
  input.accept='.csv';
  input.onchange=async e=>{
    const file=e.target.files[0];
    if(!file)return;
    const text=await file.text();
    const lines=text.split('\n').filter(l=>l.trim()&&!l.startsWith('Zusammenfassung'));
    let impCount=0,skipCount=0;
    for(const ln of lines){
      const p=ln.split(';');
      if(p.length<6||p[0]==='Ski-Paar')continue;
      const name=p[0];
      const date=p[1];
      const time=p[2];
      const act=p[3];
      const wachs=p[4]?p[4].split(', ').filter(Boolean):[];
      const geb=p[5]||'';
      const ts=new Date(date.split('.').reverse().join('-')+'T'+time);
      if(isNaN(ts))continue;
      // Duplikat-Check
      const exists=skis.some(s=>s.history.some(h=>h.ts===ts.valueOf()&&s.name===name));
      if(exists){skipCount++;continue;}
      // Ski finden oder anlegen
      let ski=skis.find(s=>s.name===name);
      if(!ski){
        ski={name:name,count:0,lastService:0,history:[]};
        skis.push(ski);
      }
      // Eintrag hinzufügen
      ski.history.push({
        type:act==='Service'?'service':'skiday',
        ts:ts.valueOf(),
        wachs:act==='Service'?wachs:undefined,
        gebiet:act==='skiday'?geb:undefined
      });
      if(act!=='Service')ski.count++;
      if(act==='Service')ski.lastService=ski.count;
      impCount++;
    }
    save();render();
    alert(`Importiert: ${impCount}\nÜbersprungen (Duplikate): ${skipCount}`);
  };
  input.click();
}
